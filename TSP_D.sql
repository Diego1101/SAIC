
CREATE PROCEDURE TSP_AGREGARSOLICITUD
(
	@ID_SERV	INT,
	@PIEZA		NVARCHAR(100),
	@DESC		NVARCHAR(200)
)
AS
BEGIN

	IF EXISTS(SELECT SR_ID ID FROM SERVICIO WHERE SR_ID=@ID_SERV)
	BEGIN
		
		INSERT INTO SOLICITUD VALUES(@ID_SERV, 0, @PIEZA, 1, @DESC) 
		SELECT '1' --AGREGADA
	END
	ELSE SELECT '0' -- NO EXIXSTE EL SERVICIO
END
GO

CREATE PROCEDURE TSP_DATOSMAQUINA
(
	@ID_MQ		INT
)
AS
BEGIN

	IF EXISTS(SELECT MQ_ID FROM MAQUINA WHERE @ID_MQ=MQ_ID)
	BEGIN
		SELECT MQ_ID_EMP EMP, MQ_ID_INV INV, MQ_MODELO MODELO, MQ_NOSERIE NOSERIE, MQ_ESTATUS ESTATUS, MQ_PRECIO PRECIO, MQ_DESCRIPCION DESCR, MQ_CONTADOR CONT, MQ_FOTO FOTO, MQ_ULT_SERVICIO ULT  
		FROM MAQUINA
		WHERE MQ_ID = @ID_MQ
	END

END
GO

CREATE PROCEDURE TSP_TERMINARSERVICIO
(
	@ID_SERV INT,
	@SOL NVARCHAR(500),
	@EDO NVARCHAR(500),
	@CONT INT
)
AS
BEGIN
	IF EXISTS(SELECT * FROM SERVICIO WHERE SR_ID=@ID_SERV)
	BEGIN
		UPDATE SERVICIO
		SET SR_STATUS=2, SR_ESTADO=@EDO, SR_SOLUCION=@SOL, SR_FECHA_FIN = GETDATE(), SR_CONTADOR=@CONT
		WHERE SR_ID=@ID_SERV
		SELECT '1' ID

	END
	ELSE SELECT '0' ID
END 
GO

CREATE PROCEDURE TSP_CREARSERVICIO
(
	@MQ		INT,
	@PROBLEMA NVARCHAR(200)
)
AS BEGIN
	IF EXISTS (SELECT * FROM MAQUINA WHERE MQ_ID=@MQ)
	BEGIN
		DECLARE @NUMSERV AS INT
		DECLARE @EMP AS INT
		SELECT TOP 1 @NUMSERV=SR_NUMSERV+1 FROM SERVICIO ORDER BY SR_NUMSERV desc
		SELECT @EMP=MQ_ID_EMP FROM MAQUINA WHERE MQ_ID=@MQ

		INSERT INTO SERVICIO
		VALUES(0, @NUMSERV, @MQ, @EMP, 1, 1, '', @PROBLEMA, '', '', 0, GETDATE(), GETDATE(), NULL)

		SELECT TOP 1 SR_NUMSERV FROM SERVICIO ORDER BY SR_ID
	END
	ELSE SELECT '0' ID
END
GO


CREATE PROCEDURE TSP_ACTUALIZAREMPLEADO
(
	@ID_EMP INT,
	@NOMBRE NVARCHAR(20), 
	@AP	NVARCHAR(20),
	@SEXO INT,
	@DIR NVARCHAR(250),
	@TEL NVARCHAR(20),
	@CORREO NVARCHAR(150),
	@FOTO NVARCHAR(300)
)
AS BEGIN
	UPDATE EMPLEADO
	SET EM_NOMBRE=@NOMBRE, EM_APELLIDO=@AP, EM_SEXO=@SEXO, EM_DIRECCION=@DIR, EM_TEL=@TEL, EM_CORREO=@CORREO, EM_FOTO=@FOTO
	WHERE EM_ID=@ID_EMP
	SELECT '1'
END
GO

CREATE PROCEDURE TSP_CAMBIARCONTRAEMP
(
	@ID INT,
	@ANT NVARCHAR(50),
	@NV NVARCHAR(50)
)
AS
BEGIN
	IF EXISTS(SELECT * FROM EMPLEADO WHERE EM_ID=@ID AND EM_CONTRA=@ANT)
	BEGIN
		UPDATE EMPLEADO
		SET EM_CONTRA=@NV
		WHERE EM_ID=@ID
		SELECT '1'
	END
	ELSE SELECT '0'
END
GO

CREATE PROCEDURE TSP_REGCLIENTES
(
	@NOMBRE NVARCHAR(20),
	@APELLIDO NVARCHAR(20), 
	@USU	NVARCHAR(15),
	@CONTRA NVARCHAR(15),
	@FOTO NVARCHAR(300),
	@SEXO INT, 
	@CALLE NVARCHAR(20),
	@CIUDAD NVARCHAR(20),
	@ESTADO NVARCHAR(20),
	@CP NVARCHAR(10),
	@CORREO NVARCHAR(150),
	@TELEFONO NVARCHAR(12)
)
AS BEGIN
IF EXISTS(SELECT * FROM CLIENTE WHERE CL_USU=@USU)
BEGIN
	SELECT '0'
END
ELSE
BEGIN
	INSERT INTO CLIENTE VALUES(@NOMBRE, @APELLIDO, @USU, @CONTRA, @FOTO, GETDATE(), @SEXO, @CALLE, @CIUDAD, @ESTADO, @CP, @CORREO, @TELEFONO, 1, GETDATE())
	SELECT '1'
END
END
GO


SELECT CN_FOLIO FOLIO, RN_NUMCOPIAS COPIAS, MQ_MODELO MODELO  FROM CONTRATO, RENTA, MAQUINA
WHERE CN_TIPO=2 AND CN_ESTATUS=1 AND CN_ID_CLI=2 AND RN_ID_CONTRATO=CN_ID AND RN_ID_MQ=MQ_ID

SELECT MQ_ID ID  FROM CONTRATO, RENTA, MAQUINA
WHERE CN_TIPO=2 AND CN_ESTATUS=1 AND CN_ID_CLI=2 AND RN_ID_CONTRATO=CN_ID AND RN_ID_MQ=MQ_ID

SELECT * FROM RENTA
SELECT * FROM CLIENTE
SELECT * FROM CONTRATO
SELECT * FROM MAQUINA
SELECT * FROM EMPLEADO
SELECT * FROM SERVICIO

UPDATE CONTRATO
SET CN_FOLIO=2883
WHERE CN_ID=1

--exec sp_who2
--exec kill 56


